<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map Editor | World of Myrdae</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;900&family=Cinzel+Decorative:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Inter:wght@400;500;600;700&family=Simonetta:ital,wght@0,400;0,900;1,400;1,900&display=swap"
    rel="stylesheet">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/dnd-theme.css">
  <link rel="stylesheet" href="css/editor.css">
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #050508;
    }

    .editor-layout {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    .editor-sidebar {
      width: 400px;
      min-width: 400px;
      flex-shrink: 0;
      background: #111;
      border-right: 1px solid var(--color-gold);
      display: flex;
      flex-direction: column;
      z-index: 10;
      overflow-y: auto;
    }

    .editor-map-area {
      flex-grow: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .map-container {
      flex-grow: 1;
      cursor: crosshair;
      background: #050508;
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .map-image {
      width: 100%;
      height: auto;
      display: block;
      will-change: transform;
      transform-origin: 0 0;
      backface-visibility: hidden;
      perspective: 1000;
      -webkit-font-smoothing: subpixel-antialiased;
    }

    .map-controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 100;
    }

    .map-btn {
      width: 40px;
      height: 40px;
      background: rgba(10, 10, 15, 0.8);
      border: 1px solid var(--color-gold);
      color: var(--color-gold);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .map-btn:hover {
      background: var(--color-gold);
      color: #000;
    }

    .map-coords {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      background: rgba(0, 0, 0, 0.7);
      padding: 0.25rem 0.5rem;
      border: 1px solid var(--color-gold);
      color: var(--color-gold);
      font-family: 'Inter', sans-serif;
      font-size: 0.8rem;
      z-index: 100;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div class="editor-layout">
    <div class="editor-sidebar" id="editor-sidebar">
      <div style="padding: 1rem; border-bottom: 1px solid #333; text-align: center;">
        <h2 style="margin: 0; color: var(--color-gold); font-family: 'Cinzel', serif;">Map Editor</h2>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
          <button class="btn btn-secondary" onclick="Editor.refreshMap()" style="flex: 1;"><i
              class="fa-solid fa-sync"></i> Refresh Map</button>
          <button class="btn btn-secondary" onclick="Editor.reloadPage()" style="flex: 1;"><i
              class="fa-solid fa-rotate-right"></i> Reload Data</button>
        </div>
      </div>

      <!-- Editor Tabs -->
      <div class="editor-tabs">
        <button class="editor-tab active" onclick="Editor.switchTab('locations')">Locations</button>
        <button class="editor-tab" onclick="Editor.switchTab('roads')">Roads</button>
      </div>

      <!-- Locations Tab Content -->
      <div id="tab-locations" class="tab-content active" style="padding: 1rem;">
        <p style="font-size: 0.8rem; color: #888;">Click on the map to place a new location.</p>

        <select id="location-list" class="form-control"
          style="margin-bottom: 1rem; font-family: 'Cinzel', serif; font-size: 1rem; background-color: #1a1614; color: #d4af37; border: 1px solid #584433; padding: 0.5rem; cursor: pointer; width: 100%;"
          onchange="if(this.value) { Editor.selectLocation(this.value); } else { Editor.cancelLocation(); }">
          <!-- Populated by JS -->
        </select>

        <div id="location-form-area" style="display: none;">
          <h3 id="form-title" style="margin-top:0; color:var(--color-gold);">Edit Location</h3>

          <div class="form-group">
            <label>ID (auto-generated if empty)</label>
            <input type="text" id="loc-id" class="form-control">
          </div>

          <div class="form-group">
            <label>Name (\n for newline)</label>
            <input type="text" id="loc-name" class="form-control" required>
          </div>

          <div class="form-group" style="margin-top: 0.25rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="loc-hideLabel">
              Hide Label <span style="color: #888; font-size: 0.8rem;">(marker only, no text on map)</span>
            </label>
          </div>

          <div class="form-inline">
            <div class="form-group" style="flex:1;">
              <label>X (%)</label>
              <input type="number" id="loc-x" class="form-control" step="0.01" required>
            </div>
            <div class="form-group" style="flex:1;">
              <label>Y (%)</label>
              <input type="number" id="loc-y" class="form-control" step="0.01" required>
            </div>
          </div>

          <div class="form-group">
            <label>Type</label>
            <select id="loc-type" class="form-control">
              <option value="capital">Capital</option>
              <option value="city">City</option>
              <option value="town">Town</option>
              <option value="village">Village</option>
              <option value="port">Port</option>
              <option value="ruins">Ruins</option>
              <option value="landmark">Landmark</option>
              <option value="poi">POI</option>
              <option value="region">Region Label</option>
              <option value="water">Water Label</option>
              <option value="river">River Label</option>
            </select>
          </div>

          <div class="form-group">
            <label>Region</label>
            <input type="text" id="loc-region" class="form-control">
          </div>

          <div class="form-group">
            <label>Description (Tooltip)</label>
            <textarea id="loc-desc" class="form-control" rows="2"></textarea>
          </div>

          <div class="form-group">
            <label>Details (Extra Italic Info)</label>
            <textarea id="loc-details" class="form-control" rows="2"></textarea>
          </div>

          <div class="form-group">
            <label>Link URL (opens in new tab)</label>
            <input type="text" id="loc-link" class="form-control" placeholder="https://example.com/page">
          </div>

          <details style="margin-top: 1rem; margin-bottom: 1rem;">
            <summary style="cursor: pointer; color: var(--color-gold); font-size: 0.9rem;">Advanced Typography / Markers
            </summary>
            <div style="padding-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
              <div class="form-group"><label>Font Family</label><input type="text" id="loc-fontFamily"
                  class="form-control" placeholder="Garamond MT"></div>
              <div class="form-group"><label>Font Size</label><input type="number" id="loc-fontSize"
                  class="form-control" step="1"></div>
              <div class="form-group"><label>Font Weight</label><input type="text" id="loc-fontWeight"
                  class="form-control" placeholder="300"></div>
              <div class="form-group"><label>Font Style</label><input type="text" id="loc-fontStyle"
                  class="form-control" placeholder="Italic"></div>

              <div class="form-group"><label>Marker Size Mult (0 to hide)</label><input type="number"
                  id="loc-markerSize" class="form-control" step="0.1" value="0.25"></div>
              <div class="form-group"><label>Marker Offset X</label><input type="number" id="loc-markerOffsetX"
                  class="form-control" step="1" value="0"></div>
              <div class="form-group"><label>Marker Offset Y</label><input type="number" id="loc-markerOffsetY"
                  class="form-control" step="1" value="0"></div>
              <div class="form-group"><label>Label Offset X</label><input type="number" id="loc-labelOffsetX"
                  class="form-control" step="1"></div>
              <div class="form-group"><label>Label Offset Y</label><input type="number" id="loc-labelOffsetY"
                  class="form-control" step="1"></div>
              <div class="form-group"><label>Rotation (degrees)</label><input type="number" id="loc-rotation"
                  class="form-control" step="1"></div>
              <div class="form-group"><label>Text Curve (Arc bend, e.g. -50 to 50)</label><input type="number"
                  id="loc-textCurve" class="form-control" step="1"></div>
              <div class="form-group"><label>Opacity</label><input type="number" id="loc-opacity" class="form-control"
                  step="0.1" max="1" min="0"></div>
            </div>
          </details>

          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="Editor.saveLocation()">Save Location</button>
            <button class="btn btn-secondary" onclick="Editor.cancelLocation()">Cancel</button>
            <button class="btn" onclick="Editor.deleteLocation()"
              style="background:#500; border-color:#800; color:#fff;" id="btn-del-loc">Delete</button>
          </div>
        </div>
      </div>

      <!-- Roads Tab Content -->
      <div id="tab-roads" class="tab-content" style="padding: 1rem; display: none;">
        <p style="font-size: 0.8rem; color: #888;">Select a road to edit, or click 'New Road' to start plotting.</p>

        <select id="road-list" class="form-control"
          style="margin-bottom: 1rem; font-family: 'Cinzel', serif; font-size: 1rem; background-color: #1a1614; color: #d4af37; border: 1px solid #584433; padding: 0.5rem; cursor: pointer; width: 100%;"
          onchange="if(this.value) { Editor.selectRoad(this.value); } else { Editor.cancelRoad(); }">
          <!-- Populated by JS -->
        </select>

        <button class="btn btn-secondary" onclick="Editor.newRoad()" style="width: 100%; margin-bottom: 1rem;">+ New
          Road</button>

        <div id="road-form-area" style="display: none;">
          <h3 id="road-form-title" style="margin-top:0; color:var(--color-gold);">Edit Road</h3>

          <div class="form-group">
            <label>ID</label>
            <input type="text" id="road-id" class="form-control">
          </div>

          <div class="form-group">
            <label>Type</label>
            <select id="road-type" class="form-control">
              <option value="major">Major Road</option>
              <option value="minor">Minor Road</option>
              <option value="river">River</option>
              <option value="border">Border</option>
            </select>
          </div>

          <div class="form-group">
            <label>Name (\\n for newline)</label>
            <input type="text" id="road-name" class="form-control">
          </div>

          <div class="form-group">
            <label><input type="checkbox" id="road-curved" checked> Curved Lines</label>
          </div>

          <details style="margin-top: 1rem; margin-bottom: 1rem;">
            <summary style="cursor: pointer; color: var(--color-gold); font-size: 0.9rem;">Advanced Road Styling
            </summary>
            <div style="padding-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
              <div class="form-group"><label>Color Override</label><input type="text" id="road-color"
                  class="form-control" placeholder="#ffffff or rgba(...)"></div>
              <div class="form-group"><label>Width Multiplier</label><input type="number" id="road-width"
                  class="form-control" step="0.1"></div>
              <div class="form-group"><label>Dashed Style ("true", "false", or dasharray)</label><input type="text"
                  id="road-dashed" class="form-control" placeholder="e.g. true, false, or 4,4"></div>
              <div class="form-group"><label>Dash Length Multiplier</label><input type="number" id="road-dashLength"
                  class="form-control" step="0.1"></div>
              <div class="form-group"><label>Gap Length Multiplier</label><input type="number" id="road-gapLength"
                  class="form-control" step="0.1"></div>
            </div>
          </details>

          <details style="margin-top: 0; margin-bottom: 1rem;">
            <summary style="cursor: pointer; color: var(--color-gold); font-size: 0.9rem;">Road Label Typography
            </summary>
            <div style="padding-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
              <div class="form-group"><label>Font Family</label><input type="text" id="road-fontFamily"
                  class="form-control" placeholder="Simonetta"></div>
              <div class="form-group"><label>Font Size</label><input type="number" id="road-fontSize"
                  class="form-control" step="1" placeholder="12"></div>
              <div class="form-group"><label>Font Weight</label><input type="text" id="road-fontWeight"
                  class="form-control" placeholder="400"></div>
              <div class="form-group"><label>Font Style</label><input type="text" id="road-fontStyle"
                  class="form-control" placeholder="Italic"></div>
              <div class="form-group"><label>Label Opacity</label><input type="number" id="road-labelOpacity"
                  class="form-control" step="0.1" min="0" max="1" placeholder="0.7"></div>
              <div class="form-group"><label>Label Position (% along road, 0-100)</label><input type="number"
                  id="road-labelOffset" class="form-control" step="1" min="0" max="100" placeholder="50"></div>
              <div class="form-group">
                <label>Label Side</label>
                <select id="road-labelSide" class="form-control">
                  <option value="top">Top (above road)</option>
                  <option value="bottom">Bottom (below road)</option>
                </select>
              </div>
              <div class="form-group">
                <label><input type="checkbox" id="road-labelReverse"> Reverse Label Direction</label>
              </div>
            </div>
          </details>

          <div class="form-group">
            <label>Start Location <span style="color:#0a0;">(Required)</span></label>
            <select id="road-start-location" class="form-control" onchange="Editor.setRoadStartLocation(this.value)">
              <option value="">-- Select Start Location --</option>
            </select>
          </div>

          <div class="form-group">
            <label>End Location <span style="color:#a00;">(Required)</span></label>
            <select id="road-end-location" class="form-control" onchange="Editor.setRoadEndLocation(this.value)">
              <option value="">-- Select End Location --</option>
            </select>
          </div>

          <p style="font-size: 0.8rem; margin: 0.5rem 0; color: #888;">Road Path (<span style="color:#0a0;">START</span>
            → Waypoints → <span style="color:#a00;">END</span>):</p>
          <div id="road-points-list"
            style="background:#000; padding:0.5rem; border:1px solid #333; font-size:0.75rem; max-height:150px; overflow-y:auto; margin-bottom: 0.5rem;">
          </div>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <button class="btn btn-secondary" onclick="Editor.clearRoadPoints()"
              style="flex: 1; font-size: 0.75rem; padding: 0.4rem;">
              <i class="fa-solid fa-trash"></i> Clear Waypoints
            </button>
          </div>
          <p style="font-size: 0.75rem; color: #aaa;">
            <i class="fa-solid fa-circle-info"></i> Roads must start and end at locations. Use dropdowns above or click
            location markers on the map. Click empty map areas to add intermediate waypoints (optional). Click the
            pencil icon to edit waypoint coordinates.
          </p>

          <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="Editor.saveRoad()" style="flex: 1;">
              <i class="fa-solid fa-floppy-disk"></i> Save Road
            </button>
            <button class="btn btn-secondary" onclick="Editor.cancelRoad()" style="flex: 1;">
              Cancel
            </button>
            <button class="btn" onclick="Editor.deleteRoad()"
              style="background:#500; border-color:#800; color:#fff; flex: 1;" id="btn-del-road">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </div>
          <p style="font-size: 0.7rem; color: #888; margin-top: 0.5rem; font-style: italic;">
            <i class="fa-solid fa-circle-info"></i> Points are auto-saved when added/removed. Click "Save Road" to
            finalize changes.
          </p>
        </div>
      </div>
    </div>

    <div class="editor-map-area">
      <div class="map-container" id="map-container">
        <div class="map-controls">
          <button class="map-btn" onclick="MapController.reset('map-container', 'map-image')" title="Reset View">
            <i class="fa-solid fa-house"></i>
          </button>
          <button class="map-btn" id="coords-toggle" onclick="toggleCoords()" title="Toggle Coordinate Tracker"
            style="opacity: 1;">
            <i class="fa-solid fa-crosshairs"></i>
          </button>
        </div>
        <div class="map-coords" id="map-coords">X: — Y: —</div>
        <img src="images/Myrdae.jpg" alt="Map of Myrdae" class="map-image" id="map-image" draggable="false">
      </div>
    </div>
  </div>

  <script src="js/locations-db.js"></script>
  <script src="js/campaign-data.js"></script>
  <script src="js/map.js"></script>
  <script src="js/map-overlay.js"></script>
  <script src="js/editor.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Force loading from defaults for the editor to avoid localStorage confusing things
      // We will manipulate the WORLD_LOCATIONS object directly in memory or a copy of it.
      await Editor.init();

      MapController.init('map-container', 'map-image', {
        onTransform: (transformStr, scale, tx, ty) => {
          const overlay = document.getElementById('map-container-overlay');
          if (overlay) {
            overlay.style.transform = transformStr;
            overlay.style.transformOrigin = '0 0';
          }
        }
      });

      // Crucial: init the map overlay AFTER Editor.init overrides CampaignData
      MapOverlay.init('map-container', 'map-image');

      // Wire map clicks to Editor
      const container = document.getElementById('map-container');
      const mapImg = document.getElementById('map-image');

      // We need to capture mousedown/mouseup to differentiate drag vs click
      let isDraggingMap = false;
      let startX, startY;

      container.addEventListener('mousedown', (e) => {
        isDraggingMap = false;
        startX = e.clientX;
        startY = e.clientY;
      });

      container.addEventListener('mousemove', (e) => {
        if (Math.abs(e.clientX - startX) > 3 || Math.abs(e.clientY - startY) > 3) {
          isDraggingMap = true;
        }
      });

      container.addEventListener('mouseup', (e) => {
        if (isDraggingMap) return; // Ignore drag end

        // Check if click was on a location marker (for roads tab)
        if (Editor.state && Editor.state.tab === 'roads') {
          const clickedMarker = e.target.closest('.marker-group');
          if (clickedMarker) {
            const locId = clickedMarker.getAttribute('data-location-id');
            if (locId) {
              e.stopPropagation();
              e.preventDefault();
              Editor.handleLocationClick(locId);
              return;
            }
          }
        }

        const rect = container.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        const state = MapController.getInstanceState('map-container');
        if (!state) return;
        const scale = state.scale;
        const tx = state.pointX;
        const ty = state.pointY;

        const cw = container.offsetWidth;
        const imgDisplayWidth = cw * scale;
        const imgDisplayHeight = (mapImg.naturalHeight / mapImg.naturalWidth) * cw * scale;

        const imgX = (mouseX - tx) / imgDisplayWidth * 100;
        const imgY = (mouseY - ty) / imgDisplayHeight * 100;

        Editor.handleMapClick(imgX, imgY);
      });
    });

    // Simple coordinate tracker inside editor
    function toggleCoords() {
      const display = document.getElementById('map-coords');
      const btn = document.getElementById('coords-toggle');
      if (display.style.display === 'none') {
        display.style.display = 'block';
        btn.style.opacity = '1';
      } else {
        display.style.display = 'none';
        btn.style.opacity = '0.5';
      }
    }

    document.getElementById('map-container').addEventListener('mousemove', (e) => {
      const display = document.getElementById('map-coords');
      if (display.style.display === 'none') return;
      const rect = document.getElementById('map-container').getBoundingClientRect();
      const mapImg = document.getElementById('map-image');
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      const state = MapController.getInstanceState('map-container');
      if (!state) return;
      const imgDisplayWidth = rect.width * state.scale;
      const imgDisplayHeight = (mapImg.naturalHeight / mapImg.naturalWidth) * rect.width * state.scale;
      let imgX = (mouseX - state.pointX) / imgDisplayWidth * 100;
      let imgY = (mouseY - state.pointY) / imgDisplayHeight * 100;
      if (imgX < 0) imgX = 0; if (imgX > 100) imgX = 100;
      if (imgY < 0) imgY = 0; if (imgY > 100) imgY = 100;
      display.textContent = `X: ${imgX.toFixed(2)}  Y: ${imgY.toFixed(2)}`;
    });
  </script>
</body>

</html>